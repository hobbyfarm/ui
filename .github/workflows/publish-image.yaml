name: publish image
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 2
    - name: tag version if bumped
      run: |
        if git diff HEAD~1 package.json | grep '"version":'; then
          version="$(cat package.json | jq -r '.version')"
          git tag $version
          git push origin $version
        fi
    - name: build image
      run: docker build . -t ${{ github.repository }}
    - name: login to registry
      run: echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login -u "${{ secrets.REGISTRY_USER }}" --password-stdin
    - name: push image
      run: |
        for tag in latest $(git tag -l --points-at HEAD); do
          docker push ${{ github.repository }}:$tag
        done

