name: Main
on: [push, pull_request]

env:
  app_image: hobbyfarm/ui

  should_push_image: |-
    ${{
      github.event_name == 'push' && (
        github.ref_type == 'tag' ||
        github.ref_name == 'master'
      )
    }}

  should_tag_latest: |-
    ${{
      github.event_name == 'push' &&
      github.ref_type == 'tag'
    }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master

      - name: Setup npm cache
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'npm'

      - name: Install deps
        run: npm install

      - name: Lint
        run: |
          npm run lint

      - name: Check Code Style
        run: |
          npm run prettier:check

      - name: Build
        run: npm run build:prod

      - name: Build
        run: |
          docker build -f cicd/Dockerfile -t $app_image:${GIT_COMMIT_SHORT_HASH:-dev} .

      - name: Docker Login
        if: fromJSON(env.should_push_image)
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" \
            | docker login -u "${{ secrets.REGISTRY_USER }}" --password-stdin

      - name: Docker Push
        if: fromJSON(env.should_push_image)
        run: |
          safe_ref=$(echo "${{ github.ref_name }}" | sed -e 's/[^a-zA-Z0-9\-\.]/-/g')
          publish_tag=$app_image:$safe_ref

          docker tag $app_image:${GIT_COMMIT_SHORT_HASH:-dev} $publish_tag
          docker push $publish_tag

      - name: Docker Push Latest
        if: fromJSON(env.should_tag_latest)
        run: |
          docker tag $app_image:${GIT_COMMIT_SHORT_HASH:-dev} $app_image:latest
          docker push $app_image:latest
