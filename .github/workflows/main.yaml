name: Main
on: [push, pull_request]

env:
  app_image: hobbyfarm/ui
  sdk_image: hobbyfarm/ui-sdk
  dockerfile: cicd/docker/Dockerfile

  should_push_image: |-
    ${{
      github.event_name == 'push' && (
        github.ref_type == 'tag' ||
        github.ref_name == 'master'
      )
    }}

  should_tag_latest: |-
    ${{
      github.event_name == 'push' &&
      github.ref_type == 'tag'
    }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      
    - name: Checkout
      uses: actions/checkout@master

    - name: Set Git Version
      run: ./cicd/git-version.sh

    - name: Build
      run: |
        docker build -f $dockerfile --tag $sdk_image --target sdk .

    - name: Build Release
      if: fromJSON(env.should_push_image)
      run: |
        docker build -f $dockerfile --tag $app_image .

    - name: Compute Docker Tag
      if: fromJSON(env.should_push_image)
      id: compute_docker_tag
      run: |
        tag=${GITHUB_REF#refs/tags/}
        branch=${GITHUB_REF#refs/heads/}
        if [ "$tag" != "$GITHUB_REF" ]; then
          tag=$(echo "$tag" | sed -e 's/[^a-zA-Z0-9\-\.]/-/g')
          echo ::set-output name=DOCKER_TAG::${tag}
        elif [ "$branch" != "$GITHUB_REF" ]; then
          branch=$(echo "$branch" | sed -e 's/[^a-zA-Z0-9\-\.]/-/g')
          echo ::set-output name=DOCKER_TAG::${branch}
        else
          echo "unable to determine docker tag" >&2
          exit 1
        fi

    - name: Docker Login
      if: fromJSON(env.should_push_image)
      run: |
        echo "${{ secrets.REGISTRY_PASSWORD }}" \
          | docker login -u "${{ secrets.REGISTRY_USER }}" --password-stdin

    - name: Docker Push
      if: fromJSON(env.should_push_image)
      run: |
        publish_tag=$app_image:${{ steps.compute_docker_tag.outputs.DOCKER_TAG }}
        
        docker tag $app_image $publish_tag
        docker push $publish_tag

    - name: Docker Push Latest
      if: fromJSON(env.should_tag_latest)
      run: docker push $app_image
