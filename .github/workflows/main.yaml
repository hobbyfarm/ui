name: Main
on: [push, pull_request]

env:
  app_image: hobbyfarm/ui
  sdk_image: hobbyfarm/ui-sdk
  dockerfile: cicd/docker/Dockerfile

  should_push_image: |-
    ${{
      github.event_name == 'push' && (
        github.ref_type == 'tag' ||
        github.ref_name == 'master'
      )
    }}

  should_tag_latest: |-
    ${{
      github.event_name == 'push' &&
      github.ref_type == 'tag'
    }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      
    - name: Checkout
      uses: actions/checkout@master

    - name: Set Git Version
      run: ./cicd/git-version.sh

    - name: Build
      run: |
        tag=$sdk_image:${GIT_COMMIT_SHORT_HASH:-dev}
        docker build -f $dockerfile --tag $tag --target sdk .

    - name: Build Release
      if: fromJSON(env.should_push_image)
      run: |
        tag=$app_image:${GIT_COMMIT_SHORT_HASH:-dev}
        docker build -f $dockerfile --tag $tag .

    - name: Compute Docker Tag
      if: fromJSON(env.should_push_image)
      id: compute_docker_tag
      run: |
        tag=${GITHUB_REF#refs/tags/}
        branch=${GITHUB_REF#refs/heads/}
        if [ "$tag" != "$GITHUB_REF" ]; then
          tag=$(echo "$tag" | sed -e 's/[^a-zA-Z0-9\-\.]/-/g')
          echo ::set-output name=DOCKER_TAG::${tag}
        elif [ "$branch" != "$GITHUB_REF" ]; then
          branch=$(echo "$branch" | sed -e 's/[^a-zA-Z0-9\-\.]/-/g')
          echo ::set-output name=DOCKER_TAG::${branch}
        else
          echo "unable to determine docker tag" >&2
          exit 1
        fi

    - name: Docker Login
      if: fromJSON(env.should_push_image)
      run: |
        echo "${{ secrets.REGISTRY_PASSWORD }}" \
          | docker login -u "${{ secrets.REGISTRY_USER }}" --password-stdin

    - name: Docker Tag
      if: fromJSON(env.should_push_image)
      run: |
        docker tag \
          hobbyfarm/ui:${GIT_COMMIT_SHORT_HASH:-dev} \
          hobbyfarm/ui:${{ steps.compute_docker_tag.outputs.DOCKER_TAG }}

    - name: Docker Push
      if: fromJSON(env.should_push_image)
      run: |
        docker push \
          hobbyfarm/ui:${{ steps.compute_docker_tag.outputs.DOCKER_TAG }}

    - name: Docker Tag Latest
      if: fromJSON(env.should_tag_latest)
      run: |
        docker tag \
          hobbyfarm/ui:${GIT_COMMIT_SHORT_HASH:-dev} \
          hobbyfarm/ui:latest

    - name: Docker Push Latest
      if: fromJSON(env.should_tag_latest)
      run: |
        docker push \
          hobbyfarm/ui:latest
